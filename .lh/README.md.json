{
    "sourceFile": "README.md",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1769775279115,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1769925646512,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -116,9 +116,9 @@\n cd discount\n ./gradlew test\n ```\n \n-The tests use TestContainers and will automatically start a PostgreSQL container for integration testing.\n+The tests use H2 database in PostgreSQL compatibility mode for fast, in-memory testing.\n \n ---\n \n ## ðŸ§ª Example curl Commands\n@@ -142,8 +142,16 @@\n **Example Response:**\n ```json\n [\n   {\n+    \"id\": \"headphones-se\",\n+    \"name\": \"Wireless Headphones\",\n+    \"basePrice\": 200.0,\n+    \"country\": \"Sweden\",\n+    \"discounts\": [],\n+    \"finalPrice\": 250.0\n+  },\n+  {\n     \"id\": \"laptop-se\",\n     \"name\": \"Gaming Laptop\",\n     \"basePrice\": 1000.0,\n     \"country\": \"Sweden\",\n@@ -165,18 +173,48 @@\n ```bash\n curl -X GET \"http://localhost:8082/products?country=Germany\"\n ```\n \n+**Example Response:**\n+```json\n+[\n+  {\n+    \"id\": \"laptop-de\",\n+    \"name\": \"Gaming Laptop\",\n+    \"basePrice\": 1200.0,\n+    \"country\": \"Germany\",\n+    \"discounts\": [],\n+    \"finalPrice\": 1428.0\n+  },\n+  {\n+    \"id\": \"phone-de\",\n+    \"name\": \"Smartphone\",\n+    \"basePrice\": 900.0,\n+    \"country\": \"Germany\",\n+    \"discounts\": [],\n+    \"finalPrice\": 1071.0\n+  },\n+  {\n+    \"id\": \"tablet-de\",\n+    \"name\": \"Tablet Pro\",\n+    \"basePrice\": 600.0,\n+    \"country\": \"Germany\",\n+    \"discounts\": [],\n+    \"finalPrice\": 714.0\n+  }\n+]\n+```\n+\n **Get products with invalid country (should return 400):**\n ```bash\n curl -X GET \"http://localhost:8082/products?country=InvalidCountry\"\n ```\n \n ### 2. Apply Discounts\n \n-**Apply a 15% discount to a laptop:**\n+**Apply a 15% discount to a fresh product:**\n ```bash\n-curl -X PUT \"http://localhost:8082/products/laptop-se/discount\" \\\n+curl -X PUT \"http://localhost:8082/products/headphones-se/discount\" \\\n   -H \"Content-Type: application/json\" \\\n   -d '{\n     \"discountId\": \"summer-sale-2024\",\n     \"percent\": 15.0\n@@ -187,26 +225,26 @@\n ```json\n {\n   \"message\": \"Discount applied successfully\",\n   \"product\": {\n-    \"id\": \"laptop-se\",\n-    \"name\": \"Gaming Laptop\",\n-    \"basePrice\": 1000.0,\n+    \"id\": \"headphones-se\",\n+    \"name\": \"Wireless Headphones\",\n+    \"basePrice\": 200.0,\n     \"country\": \"Sweden\",\n     \"discounts\": [\n       {\n         \"discountId\": \"summer-sale-2024\",\n         \"percent\": 15.0\n       }\n     ],\n-    \"finalPrice\": 1062.5\n+    \"finalPrice\": 212.5\n   }\n }\n ```\n \n **Apply the same discount again (should be idempotent):**\n ```bash\n-curl -X PUT \"http://localhost:8082/products/laptop-se/discount\" \\\n+curl -X PUT \"http://localhost:8082/products/headphones-se/discount\" \\\n   -H \"Content-Type: application/json\" \\\n   -d '{\n     \"discountId\": \"summer-sale-2024\",\n     \"percent\": 15.0\n@@ -217,33 +255,57 @@\n ```json\n {\n   \"message\": \"Discount already applied\",\n   \"product\": {\n-    \"id\": \"laptop-se\",\n-    \"name\": \"Gaming Laptop\",\n-    \"basePrice\": 1000.0,\n+    \"id\": \"headphones-se\",\n+    \"name\": \"Wireless Headphones\",\n+    \"basePrice\": 200.0,\n     \"country\": \"Sweden\",\n     \"discounts\": [\n       {\n         \"discountId\": \"summer-sale-2024\",\n         \"percent\": 15.0\n       }\n     ],\n-    \"finalPrice\": 1062.5\n+    \"finalPrice\": 212.5\n   }\n }\n ```\n \n **Apply a second different discount (compound discount calculation):**\n ```bash\n-curl -X PUT \"http://localhost:8082/products/laptop-se/discount\" \\\n+curl -X PUT \"http://localhost:8082/products/headphones-se/discount\" \\\n   -H \"Content-Type: application/json\" \\\n   -d '{\n     \"discountId\": \"loyalty-bonus-2024\",\n     \"percent\": 5.0\n   }'\n ```\n \n+**Example Response:**\n+```json\n+{\n+  \"message\": \"Discount applied successfully\",\n+  \"product\": {\n+    \"id\": \"headphones-se\",\n+    \"name\": \"Wireless Headphones\",\n+    \"basePrice\": 200.0,\n+    \"country\": \"Sweden\",\n+    \"discounts\": [\n+      {\n+        \"discountId\": \"summer-sale-2024\",\n+        \"percent\": 15.0\n+      },\n+      {\n+        \"discountId\": \"loyalty-bonus-2024\",\n+        \"percent\": 5.0\n+      }\n+    ],\n+    \"finalPrice\": 201.25\n+  }\n+}\n+```\n+\n **Apply discount to non-existent product (should return 404):**\n ```bash\n curl -X PUT \"http://localhost:8082/products/non-existent/discount\" \\\n   -H \"Content-Type: application/json\" \\\n@@ -280,19 +342,28 @@\n \n ## ðŸ’¡ Price Calculation Examples\n \n ### Single Discount Example (Sweden - 25% VAT)\n-- Base Price: 1000.0\n+Using `headphones-se` with basePrice: 200.0\n+- Base Price: 200.0\n - Discount: 15%\n-- Calculation: `1000 Ã— (1 - 0.15) Ã— (1 + 0.25) = 1000 Ã— 0.85 Ã— 1.25 = 1062.5`\n+- Calculation: `200 Ã— (1 - 0.15) Ã— (1 + 0.25) = 200 Ã— 0.85 Ã— 1.25 = 212.5`\n \n-### Multiple Discounts Example (Germany - 19% VAT)\n-- Base Price: 1200.0\n-- Discount 1: 10%\n-- Discount 2: 5%\n-- Total Discount: `1 - (1-0.10) Ã— (1-0.05) = 1 - 0.90 Ã— 0.95 = 14.5%`\n-- Calculation: `1200 Ã— (1 - 0.145) Ã— (1 + 0.19) = 1200 Ã— 0.855 Ã— 1.19 = 1220.94`\n+### Multiple Discounts Example (Compound Calculation)\n+Using `headphones-se` with two discounts:\n+- Base Price: 200.0\n+- Discount 1: 15% (summer-sale-2024)\n+- Discount 2: 5% (loyalty-bonus-2024)\n+- Total Discount: `1 - (1-0.15) Ã— (1-0.05) = 1 - 0.85 Ã— 0.95 = 19.25%`\n+- Calculation: `200 Ã— (1 - 0.1925) Ã— (1 + 0.25) = 200 Ã— 0.8075 Ã— 1.25 = 201.875 â‰ˆ 201.88`\n \n+### Germany VAT Example\n+Using `tablet-de` with basePrice: 600.0\n+- Base Price: 600.0\n+- No discounts: 0%\n+- Germany VAT: 19%\n+- Calculation: `600 Ã— (1 - 0) Ã— (1 + 0.19) = 600 Ã— 1.0 Ã— 1.19 = 714.0`\n+\n ---\n \n ## ðŸ”§ Configuration\n \n"
                }
            ],
            "date": 1769775279115,
            "name": "Commit-0",
            "content": "# ðŸ§© Country-Based Product API â€” Technical Assessment\n\nBuild a single Kotlin (Ktor) service that manages products and discounts.\n\n## ðŸ“¦ Problem Description\nYou'll build a Product API that:\n- Stores a catalog of products.\n- Calculates final prices including country VAT and discounts.\n- Allows concurrent discount application, but guarantees:\n  > \"The same discount cannot be applied more than once to the same product â€” even under heavy concurrent load.\"\n\n**Final price formula:**  \n`finalPrice = basePrice Ã— (1 - totalDiscount%) Ã— (1 + VAT%)`\n\n---\n\n## ðŸ§± Data Model\n\n### Product\n| Field | Type | Description |\n|-------|------|-------------|\n| `id` | String | Unique identifier |\n| `name` | String | Product name |\n| `basePrice` | Double | Price before tax and discount |\n| `country` | String | Country name |\n| `discounts` | List<Discount> | List of applied discounts |\n\n### Discount\n| Field | Type | Description |\n|--------|------|-------------|\n| `discountId` | String | Unique discount identifier (idempotency key) |\n| `percent` | Double | Discount percentage (0â€“100, exclusive of 0) |\n\n### Country VAT Rules\n| Country | VAT |\n|----------|-----|\n| Sweden | 25% |\n| Germany | 19% |\n| France | 20% |\n\n---\n\n## ðŸ“¡ API Endpoints\n\n### `GET /products?country={country}`\nReturns all products for the given country, including their **final price**.\n\n### `PUT /products/{id}/discount`\nApplies a discount to a product in a manner that is idempotent and not subject to race conditions.\n\n**Expected behavior:**\nIf multiple clients apply the same discount concurrently:\n- Only first successful request will persist changes\n- Any identical request that follows should not update state or have any side effects\n\n---\n\n## Requirements\n- Use a persistent database for storing products and discounts (e.g. MongoDB or PostgreSQL).\n  - In-memory solutions (e.g. ConcurrentHashMap) are not allowed. Concurrency must be enforced at the database level.\n- Implement the endpoints described above (GET /products, PUT /products/{id}/discount).\n- Store products and applied discounts.\n- Calculate finalPrice including VAT and discounts.\n- Ensure the same discount cannot be applied more than once per product.\n- Demonstrate concurrency safety with a test that simulates multiple simultaneous discount requests via http endpoints.\n\n---\n\n## ðŸš€ Build and Run Instructions\n\n### Prerequisites\n- JDK 22 or higher\n- PostgreSQL 15+ (or Docker)\n\n### Option 1: Using Local PostgreSQL\n\n1. **Start PostgreSQL server** and create database:\n   ```sql\n   CREATE DATABASE discount_db;\n   CREATE USER discount_user WITH PASSWORD 'discount_pass';\n   GRANT ALL PRIVILEGES ON DATABASE discount_db TO discount_user;\n   ```\n\n2. **Clone and build the project:**\n   ```bash\n   git clone <repository-url>\n   cd code-test-nexure-elux-2025/discount\n   ./gradlew build\n   ```\n\n3. **Run the application:**\n   ```bash\n   ./gradlew run\n   ```\n\n   The API will be available at `http://localhost:8082`\n\n### Option 2: Using Docker Compose (Recommended)\n\n1. **Clone the project:**\n   ```bash\n   git clone <repository-url>\n   cd code-test-nexure-elux-2025\n   ```\n\n2. **Start with Docker Compose:**\n   ```bash\n   docker-compose up --build\n   ```\n\n   This will start both PostgreSQL and the Ktor application.\n\n### Running Tests\n\n```bash\ncd discount\n./gradlew test\n```\n\nThe tests use TestContainers and will automatically start a PostgreSQL container for integration testing.\n\n---\n\n## ðŸ§ª Example curl Commands\n\n### Setup Sample Data\n\nFirst, let's add some sample products to test with:\n\n```bash\n# Add sample products (you'll need to implement a POST endpoint for this or use direct DB inserts)\n# For this demo, the test data is created automatically when the app starts\n```\n\n### 1. Get Products by Country\n\n**Get all products for Sweden:**\n```bash\ncurl -X GET \"http://localhost:8082/products?country=Sweden\"\n```\n\n**Example Response:**\n```json\n[\n  {\n    \"id\": \"laptop-se\",\n    \"name\": \"Gaming Laptop\",\n    \"basePrice\": 1000.0,\n    \"country\": \"Sweden\",\n    \"discounts\": [],\n    \"finalPrice\": 1250.0\n  },\n  {\n    \"id\": \"phone-se\",\n    \"name\": \"Smartphone\",\n    \"basePrice\": 800.0,\n    \"country\": \"Sweden\",\n    \"discounts\": [],\n    \"finalPrice\": 1000.0\n  }\n]\n```\n\n**Get all products for Germany:**\n```bash\ncurl -X GET \"http://localhost:8082/products?country=Germany\"\n```\n\n**Get products with invalid country (should return 400):**\n```bash\ncurl -X GET \"http://localhost:8082/products?country=InvalidCountry\"\n```\n\n### 2. Apply Discounts\n\n**Apply a 15% discount to a laptop:**\n```bash\ncurl -X PUT \"http://localhost:8082/products/laptop-se/discount\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"discountId\": \"summer-sale-2024\",\n    \"percent\": 15.0\n  }'\n```\n\n**Example Response:**\n```json\n{\n  \"message\": \"Discount applied successfully\",\n  \"product\": {\n    \"id\": \"laptop-se\",\n    \"name\": \"Gaming Laptop\",\n    \"basePrice\": 1000.0,\n    \"country\": \"Sweden\",\n    \"discounts\": [\n      {\n        \"discountId\": \"summer-sale-2024\",\n        \"percent\": 15.0\n      }\n    ],\n    \"finalPrice\": 1062.5\n  }\n}\n```\n\n**Apply the same discount again (should be idempotent):**\n```bash\ncurl -X PUT \"http://localhost:8082/products/laptop-se/discount\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"discountId\": \"summer-sale-2024\",\n    \"percent\": 15.0\n  }'\n```\n\n**Example Response:**\n```json\n{\n  \"message\": \"Discount already applied\",\n  \"product\": {\n    \"id\": \"laptop-se\",\n    \"name\": \"Gaming Laptop\",\n    \"basePrice\": 1000.0,\n    \"country\": \"Sweden\",\n    \"discounts\": [\n      {\n        \"discountId\": \"summer-sale-2024\",\n        \"percent\": 15.0\n      }\n    ],\n    \"finalPrice\": 1062.5\n  }\n}\n```\n\n**Apply a second different discount (compound discount calculation):**\n```bash\ncurl -X PUT \"http://localhost:8082/products/laptop-se/discount\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"discountId\": \"loyalty-bonus-2024\",\n    \"percent\": 5.0\n  }'\n```\n\n**Apply discount to non-existent product (should return 404):**\n```bash\ncurl -X PUT \"http://localhost:8082/products/non-existent/discount\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"discountId\": \"test-discount\",\n    \"percent\": 10.0\n  }'\n```\n\n**Apply invalid discount (should return 400):**\n```bash\ncurl -X PUT \"http://localhost:8082/products/laptop-se/discount\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"discountId\": \"invalid-discount\",\n    \"percent\": 0\n  }'\n```\n\n### 3. Health Check\n\n```bash\ncurl -X GET \"http://localhost:8082/health\"\n```\n\n**Example Response:**\n```json\n{\n  \"status\": \"healthy\"\n}\n```\n\n---\n\n## ðŸ’¡ Price Calculation Examples\n\n### Single Discount Example (Sweden - 25% VAT)\n- Base Price: 1000.0\n- Discount: 15%\n- Calculation: `1000 Ã— (1 - 0.15) Ã— (1 + 0.25) = 1000 Ã— 0.85 Ã— 1.25 = 1062.5`\n\n### Multiple Discounts Example (Germany - 19% VAT)\n- Base Price: 1200.0\n- Discount 1: 10%\n- Discount 2: 5%\n- Total Discount: `1 - (1-0.10) Ã— (1-0.05) = 1 - 0.90 Ã— 0.95 = 14.5%`\n- Calculation: `1200 Ã— (1 - 0.145) Ã— (1 + 0.19) = 1200 Ã— 0.855 Ã— 1.19 = 1220.94`\n\n---\n\n## ðŸ”§ Configuration\n\nThe application can be configured via environment variables:\n\n```bash\n# Database Configuration\nDATABASE_URL=jdbc:postgresql://localhost:5432/discount_db\nDATABASE_USERNAME=discount_user\nDATABASE_PASSWORD=discount_pass\n\n# Server Configuration  \nSERVER_PORT=8082\nSERVER_HOST=0.0.0.0\n```\n\n---\n\n## ðŸ“Š Testing Concurrency\n\nThe application includes a comprehensive test suite that demonstrates concurrency safety:\n\n```bash\n# Run the specific concurrency test\n./gradlew test --tests \"*testConcurrentDiscountApplication*\"\n```\n\nThis test launches 10 simultaneous HTTP requests applying the same discount to verify that:\n1. All requests return HTTP 200 (success)\n2. The discount is applied exactly once in the database\n3. No race conditions occur\n\n---\n\n## ðŸ§© Deliverables\n\n1. **Code** for the service, runnable locally (via Gradle or Docker Compose). âœ…\n2. **README.md** with:\n    - Build and run instructions âœ…\n    - Example curl commands âœ…\n3. **ARCHITECTURE.md** with:\n    - A short design explanation âœ…\n    - Description of your concurrency approach âœ…\n    - At least one **Mermaid sequence diagram** for:\n        - `GET /products` âœ…\n        - `PUT /products/{id}/discount` âœ…\n\n---\n## ðŸ“¬ Submission\n\nWhen you're done:\n1. Push your solution to a **public GitHub repository**.\n2. Ensure we can build and run it locally.\n3. Include:\n    - Code\n    - README.md\n    - ARCHITECTURE.md (with diagrams)\n\nThen share the repository link.\n---\nâœ¨ **Good luck, and have fun!**\n---\n"
        }
    ]
}