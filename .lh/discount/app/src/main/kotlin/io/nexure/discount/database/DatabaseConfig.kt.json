{
    "sourceFile": "discount/app/src/main/kotlin/io/nexure/discount/database/DatabaseConfig.kt",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1769775281919,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1769775281919,
            "name": "Commit-0",
            "content": "package io.nexure.discount.database\n\nimport com.zaxxer.hikari.HikariConfig\nimport com.zaxxer.hikari.HikariDataSource\nimport org.jetbrains.exposed.sql.Database\nimport org.jetbrains.exposed.sql.SchemaUtils\nimport org.jetbrains.exposed.sql.transactions.transaction\n\n/**\n * Database configuration and connection management\n * Uses HikariCP for connection pooling and Exposed ORM for database operations\n */\nobject DatabaseConfig {\n    \n    private var database: Database? = null\n    \n    /**\n     * Initialize database connection with HikariCP connection pool\n     * This provides production-ready connection management\n     */\n    fun init(\n        jdbcUrl: String = System.getenv(\"DATABASE_URL\") ?: \"jdbc:postgresql://localhost:5432/discount_db\",\n        username: String = System.getenv(\"DATABASE_USERNAME\") ?: \"discount_user\", \n        password: String = System.getenv(\"DATABASE_PASSWORD\") ?: \"discount_pass\",\n        driverClassName: String = when {\n            jdbcUrl.contains(\"h2\") -> \"org.h2.Driver\"\n            jdbcUrl.contains(\"postgresql\") -> \"org.postgresql.Driver\"\n            else -> \"org.postgresql.Driver\"\n        }\n    ): Database {\n        \n        // Return existing database if already initialized with same URL\n        database?.let { existingDb ->\n            return existingDb\n        }\n        \n        // Configure HikariCP connection pool for optimal performance\n        val hikariConfig = HikariConfig().apply {\n            this.jdbcUrl = jdbcUrl\n            this.username = username\n            this.password = password\n            this.driverClassName = driverClassName\n            this.maximumPoolSize = if (jdbcUrl.contains(\"h2\")) 5 else 20 // Smaller pool for H2\n            this.minimumIdle = if (jdbcUrl.contains(\"h2\")) 1 else 5      \n            this.idleTimeout = 300000 // 5 minutes idle timeout\n            this.connectionTimeout = 30000 // 30 seconds connection timeout\n            this.leakDetectionThreshold = 60000 // 1 minute leak detection\n        }\n        \n        val dataSource = HikariDataSource(hikariConfig)\n        val db = Database.connect(dataSource)\n        \n        // Create tables if they don't exist\n        initializeTables()\n        \n        database = db\n        return db\n    }\n    \n    /**\n     * Create database tables using Exposed ORM schema utilities\n     * This is safe to run multiple times (won't recreate existing tables)\n     */\n    private fun initializeTables() {\n        transaction {\n            SchemaUtils.create(Products, ProductDiscounts)\n        }\n    }\n    \n    /**\n     * Reset database for testing purposes\n     */\n    fun reset() {\n        database = null\n    }\n}"
        }
    ]
}