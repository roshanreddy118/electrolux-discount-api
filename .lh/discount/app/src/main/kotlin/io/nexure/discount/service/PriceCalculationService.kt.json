{
    "sourceFile": "discount/app/src/main/kotlin/io/nexure/discount/service/PriceCalculationService.kt",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1769775282722,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1769925649001,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2,8 +2,9 @@\n \n import io.nexure.discount.model.Discount\n import io.nexure.discount.model.Product\n import io.nexure.discount.model.ProductResponse\n+import kotlin.math.roundToInt\n \n /**\n  * Service for calculating final product prices including discounts and VAT\n  * Implements the formula: finalPrice = basePrice × (1 - totalDiscount%) × (1 + VAT%)\n@@ -12,16 +13,19 @@\n     \n     /**\n      * Calculate the final price for a product including all discounts and VAT\n      * @param product The product to calculate price for\n-     * @return Final price after applying discounts and VAT\n+     * @return Final price after applying discounts and VAT (rounded to 2 decimal places)\n      */\n     fun calculateFinalPrice(product: Product): Double {\n         val vatRate = VatService.getVatRate(product.country)\n         val totalDiscountPercent = calculateTotalDiscountPercent(product.discounts)\n         \n         // Formula: finalPrice = basePrice × (1 - totalDiscount%) × (1 + VAT%)\n-        return product.basePrice * (1.0 - totalDiscountPercent / 100.0) * (1.0 + vatRate)\n+        val rawPrice = product.basePrice * (1.0 - totalDiscountPercent / 100.0) * (1.0 + vatRate)\n+        \n+        // Round to 2 decimal places for proper currency handling\n+        return (rawPrice * 100).roundToInt() / 100.0\n     }\n     \n     /**\n      * Convert a Product to ProductResponse with calculated final price\n"
                }
            ],
            "date": 1769775282722,
            "name": "Commit-0",
            "content": "package io.nexure.discount.service\n\nimport io.nexure.discount.model.Discount\nimport io.nexure.discount.model.Product\nimport io.nexure.discount.model.ProductResponse\n\n/**\n * Service for calculating final product prices including discounts and VAT\n * Implements the formula: finalPrice = basePrice × (1 - totalDiscount%) × (1 + VAT%)\n */\nobject PriceCalculationService {\n    \n    /**\n     * Calculate the final price for a product including all discounts and VAT\n     * @param product The product to calculate price for\n     * @return Final price after applying discounts and VAT\n     */\n    fun calculateFinalPrice(product: Product): Double {\n        val vatRate = VatService.getVatRate(product.country)\n        val totalDiscountPercent = calculateTotalDiscountPercent(product.discounts)\n        \n        // Formula: finalPrice = basePrice × (1 - totalDiscount%) × (1 + VAT%)\n        return product.basePrice * (1.0 - totalDiscountPercent / 100.0) * (1.0 + vatRate)\n    }\n    \n    /**\n     * Convert a Product to ProductResponse with calculated final price\n     * This is used for API responses\n     * @param product The product to convert\n     * @return ProductResponse with final price calculated\n     */\n    fun toProductResponse(product: Product): ProductResponse {\n        val finalPrice = calculateFinalPrice(product)\n        return ProductResponse(\n            id = product.id,\n            name = product.name,\n            basePrice = product.basePrice,\n            country = product.country,\n            discounts = product.discounts,\n            finalPrice = finalPrice\n        )\n    }\n    \n    /**\n     * Calculate total discount percentage from a list of discounts\n     * Uses compound discount calculation: 1 - (1-d1/100) * (1-d2/100) * ... * (1-dn/100)\n     * @param discounts List of discounts to calculate total from\n     * @return Total discount percentage (0-100)\n     */\n    private fun calculateTotalDiscountPercent(discounts: List<Discount>): Double {\n        if (discounts.isEmpty()) return 0.0\n        \n        // Calculate compound discount: multiply all (1 - discount%) factors\n        val remainingPriceFactor = discounts.fold(1.0) { acc, discount ->\n            acc * (1.0 - discount.percent / 100.0)\n        }\n        \n        // Total discount = 1 - remaining price factor\n        return (1.0 - remainingPriceFactor) * 100.0\n    }\n}"
        }
    ]
}