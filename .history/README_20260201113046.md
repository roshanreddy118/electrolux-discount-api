# ðŸ§© Country-Based Product API â€” Technical Assessment

Build a single Kotlin (Ktor) service that manages products and discounts.

## ðŸ“¦ Problem Description
You'll build a Product API that:
- Stores a catalog of products.
- Calculates final prices including country VAT and discounts.
- Allows concurrent discount application, but guarantees:
  > "The same discount cannot be applied more than once to the same product â€” even under heavy concurrent load."

**Final price formula:**  
`finalPrice = basePrice Ã— (1 - totalDiscount%) Ã— (1 + VAT%)`

---

## ðŸ§± Data Model

### Product
| Field | Type | Description |
|-------|------|-------------|
| `id` | String | Unique identifier |
| `name` | String | Product name |
| `basePrice` | Double | Price before tax and discount |
| `country` | String | Country name |
| `discounts` | List<Discount> | List of applied discounts |

### Discount
| Field | Type | Description |
|--------|------|-------------|
| `discountId` | String | Unique discount identifier (idempotency key) |
| `percent` | Double | Discount percentage (0â€“100, exclusive of 0) |

### Country VAT Rules
| Country | VAT |
|----------|-----|
| Sweden | 25% |
| Germany | 19% |
| France | 20% |

---

## ðŸ“¡ API Endpoints

### `GET /products?country={country}`
Returns all products for the given country, including their **final price**.

### `PUT /products/{id}/discount`
Applies a discount to a product in a manner that is idempotent and not subject to race conditions.

**Expected behavior:**
If multiple clients apply the same discount concurrently:
- Only first successful request will persist changes
- Any identical request that follows should not update state or have any side effects

---

## Requirements
- Use a persistent database for storing products and discounts (e.g. MongoDB or PostgreSQL).
  - In-memory solutions (e.g. ConcurrentHashMap) are not allowed. Concurrency must be enforced at the database level.
- Implement the endpoints described above (GET /products, PUT /products/{id}/discount).
- Store products and applied discounts.
- Calculate finalPrice including VAT and discounts.
- Ensure the same discount cannot be applied more than once per product.
- Demonstrate concurrency safety with a test that simulates multiple simultaneous discount requests via http endpoints.

---

## ðŸš€ Build and Run Instructions

### Prerequisites
- JDK 22 or higher
- PostgreSQL 15+ (or Docker)

### Option 1: Using Local PostgreSQL

1. **Start PostgreSQL server** and create database:
   ```sql
   CREATE DATABASE discount_db;
   CREATE USER discount_user WITH PASSWORD 'discount_pass';
   GRANT ALL PRIVILEGES ON DATABASE discount_db TO discount_user;
   ```

2. **Clone and build the project:**
   ```bash
   git clone <repository-url>
   cd code-test-nexure-elux-2025/discount
   ./gradlew build
   ```

3. **Run the application:**
   ```bash
   ./gradlew run
   ```

   The API will be available at `http://localhost:8082`

### Option 2: Using Docker Compose (Recommended)

1. **Clone the project:**
   ```bash
   git clone <repository-url>
   cd code-test-nexure-elux-2025
   ```

2. **Start with Docker Compose:**
   ```bash
   docker-compose up --build
   ```

   This will start both PostgreSQL and the Ktor application.

### Running Tests

```bash
cd discount
./gradlew test
```

The tests use H2 database in PostgreSQL compatibility mode for fast, in-memory testing.

---

## ðŸ§ª Example curl Commands

### Setup Sample Data

First, let's add some sample products to test with:

```bash
# Add sample products (you'll need to implement a POST endpoint for this or use direct DB inserts)
# For this demo, the test data is created automatically when the app starts
```

### 1. Get Products by Country

**Get all products for Sweden:**
```bash
curl -X GET "http://localhost:8082/products?country=Sweden"
```

**Example Response:**
```json
[
  {
    "id": "headphones-se",
    "name": "Wireless Headphones",
    "basePrice": 200.0,
    "country": "Sweden",
    "discounts": [],
    "finalPrice": 250.0
  },
  {
    "id": "laptop-se",
    "name": "Gaming Laptop",
    "basePrice": 1000.0,
    "country": "Sweden",
    "discounts": [],
    "finalPrice": 1250.0
  },
  {
    "id": "phone-se",
    "name": "Smartphone",
    "basePrice": 800.0,
    "country": "Sweden",
    "discounts": [],
    "finalPrice": 1000.0
  }
]
```

**Get all products for Germany:**
```bash
curl -X GET "http://localhost:8082/products?country=Germany"
```

**Example Response:**
```json
[
  {
    "id": "laptop-de",
    "name": "Gaming Laptop",
    "basePrice": 1200.0,
    "country": "Germany",
    "discounts": [],
    "finalPrice": 1428.0
  },
  {
    "id": "phone-de",
    "name": "Smartphone",
    "basePrice": 900.0,
    "country": "Germany",
    "discounts": [],
    "finalPrice": 1071.0
  },
  {
    "id": "tablet-de",
    "name": "Tablet Pro",
    "basePrice": 600.0,
    "country": "Germany",
    "discounts": [],
    "finalPrice": 714.0
  }
]
```

**Get products with invalid country (should return 400):**
```bash
curl -X GET "http://localhost:8082/products?country=InvalidCountry"
```

### 2. Apply Discounts

**Apply a 15% discount to a fresh product:**
```bash
curl -X PUT "http://localhost:8082/products/headphones-se/discount" \
  -H "Content-Type: application/json" \
  -d '{
    "discountId": "summer-sale-2024",
    "percent": 15.0
  }'
```

**Example Response:**
```json
{
  "message": "Discount applied successfully",
  "product": {
    "id": "headphones-se",
    "name": "Wireless Headphones",
    "basePrice": 200.0,
    "country": "Sweden",
    "discounts": [
      {
        "discountId": "summer-sale-2024",
        "percent": 15.0
      }
    ],
    "finalPrice": 212.5
  }
}
```

**Apply the same discount again (should be idempotent):**
```bash
curl -X PUT "http://localhost:8082/products/headphones-se/discount" \
  -H "Content-Type: application/json" \
  -d '{
    "discountId": "summer-sale-2024",
    "percent": 15.0
  }'
```

**Example Response:**
```json
{
  "message": "Discount already applied",
  "product": {
    "id": "headphones-se",
    "name": "Wireless Headphones",
    "basePrice": 200.0,
    "country": "Sweden",
    "discounts": [
      {
        "discountId": "summer-sale-2024",
        "percent": 15.0
      }
    ],
    "finalPrice": 212.5
  }
}
```

**Apply a second different discount (compound discount calculation):**
```bash
curl -X PUT "http://localhost:8082/products/headphones-se/discount" \
  -H "Content-Type: application/json" \
  -d '{
    "discountId": "loyalty-bonus-2024",
    "percent": 5.0
  }'
```

**Example Response:**
```json
{
  "message": "Discount applied successfully",
  "product": {
    "id": "headphones-se",
    "name": "Wireless Headphones",
    "basePrice": 200.0,
    "country": "Sweden",
    "discounts": [
      {
        "discountId": "summer-sale-2024",
        "percent": 15.0
      },
      {
        "discountId": "loyalty-bonus-2024",
        "percent": 5.0
      }
    ],
    "finalPrice": 201.25
  }
}
```

**Apply discount to non-existent product (should return 404):**
```bash
curl -X PUT "http://localhost:8082/products/non-existent/discount" \
  -H "Content-Type: application/json" \
  -d '{
    "discountId": "test-discount",
    "percent": 10.0
  }'
```

**Apply invalid discount (should return 400):**
```bash
curl -X PUT "http://localhost:8082/products/laptop-se/discount" \
  -H "Content-Type: application/json" \
  -d '{
    "discountId": "invalid-discount",
    "percent": 0
  }'
```

### 3. Health Check

```bash
curl -X GET "http://localhost:8082/health"
```

**Example Response:**
```json
{
  "status": "healthy"
}
```

---

## ðŸ’¡ Price Calculation Examples

### Single Discount Example (Sweden - 25% VAT)
Using `headphones-se` with basePrice: 200.0
- Base Price: 200.0
- Discount: 15%
- Calculation: `200 Ã— (1 - 0.15) Ã— (1 + 0.25) = 200 Ã— 0.85 Ã— 1.25 = 212.5`

### Multiple Discounts Example (Compound Calculation)
Using `headphones-se` with two discounts:
- Base Price: 200.0
- Discount 1: 15% (summer-sale-2024)
- Discount 2: 5% (loyalty-bonus-2024)
- Total Discount: `1 - (1-0.15) Ã— (1-0.05) = 1 - 0.85 Ã— 0.95 = 19.25%`
- Calculation: `200 Ã— (1 - 0.1925) Ã— (1 + 0.25) = 200 Ã— 0.8075 Ã— 1.25 = 201.875 â‰ˆ 201.88`

### Germany VAT Example
Using `tablet-de` with basePrice: 600.0
- Base Price: 600.0
- No discounts: 0%
- Germany VAT: 19%
- Calculation: `600 Ã— (1 - 0) Ã— (1 + 0.19) = 600 Ã— 1.0 Ã— 1.19 = 714.0`

---

## ðŸ”§ Configuration

The application can be configured via environment variables:

```bash
# Database Configuration
DATABASE_URL=jdbc:postgresql://localhost:5432/discount_db
DATABASE_USERNAME=discount_user
DATABASE_PASSWORD=discount_pass

# Server Configuration  
SERVER_PORT=8082
SERVER_HOST=0.0.0.0
```

---

## ðŸ“Š Testing Concurrency

The application includes a comprehensive test suite that demonstrates concurrency safety:

```bash
# Run the specific concurrency test
./gradlew test --tests "*testConcurrentDiscountApplication*"
```

This test launches 10 simultaneous HTTP requests applying the same discount to verify that:
1. All requests return HTTP 200 (success)
2. The discount is applied exactly once in the database
3. No race conditions occur

---

## ðŸ§© Deliverables

1. **Code** for the service, runnable locally (via Gradle or Docker Compose). âœ…
2. **README.md** with:
    - Build and run instructions âœ…
    - Example curl commands âœ…
3. **ARCHITECTURE.md** with:
    - A short design explanation âœ…
    - Description of your concurrency approach âœ…
    - At least one **Mermaid sequence diagram** for:
        - `GET /products` âœ…
        - `PUT /products/{id}/discount` âœ…

---
## ðŸ“¬ Submission

When you're done:
1. Push your solution to a **public GitHub repository**.
2. Ensure we can build and run it locally.
3. Include:
    - Code
    - README.md
    - ARCHITECTURE.md (with diagrams)

Then share the repository link.
---
âœ¨ **Good luck, and have fun!**
---
